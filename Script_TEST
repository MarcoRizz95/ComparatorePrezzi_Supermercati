import google.generativeai as genai
from google.colab import files, auth
import PIL.Image
import json
import gspread
from google.auth import default

# 1. NUOVA CHIAVE API E AUTENTICAZIONE
API_KEY = "------------------------"
auth.authenticate_user()
creds, _ = default()
gc = gspread.authorize(creds)
genai.configure(api_key=API_KEY)

# 2. AUTO-RILEVAMENTO MODELLO DISPONIBILE (Per evitare 404)
print("--- RICERCA MODELLI ATTIVI ---")
modelli_validi = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
# Cerchiamo nell'ordine: un modello Flash recente, altrimenti il primo disponibile
modello_scelto = next((m for m in modelli_validi if 'flash' in m.lower()), modelli_validi[0])
print(f"Utilizzerò il modello: {modello_scelto}\n")
model = genai.GenerativeModel(modello_scelto)

# MAPPA P.IVA PER NOMI SUPERMERCATI (Punto 4)
INSEGNE_MAP = {
    "04916380159": "ESSELUNGA",
    "00796350239": "MARTINELLI",
    "00212810235": "EUROSPAR",
    "00150240230": "LIDL"
}

def analizza_v8():
    try:
        sh = gc.open("Database_Prezzi")
        worksheet = sh.get_worksheet(0)
        
        # Lettura glossario per normalizzazione
        tutti_i_dati = worksheet.get_all_records()
        glossario = list(set([r['Proposta Normalizzazione'] for r in tutti_i_dati if r.get('Proposta Normalizzazione')]))
        
        print("--- CARICA SCONTRINO ---")
        uploaded = files.upload()
        if not uploaded: return
        img = PIL.Image.open(list(uploaded.keys())[0])
        
        prompt = f"""
        Analizza questo scontrino riga per riga con estrema precisione.
        
        REGOLE CONTABILI:
        1. NO AGGREGAZIONE: Ogni riga fisica dello scontrino deve essere un oggetto nel JSON. 
        2. SCONTI: Se una riga sotto un prodotto è uno sconto (segno '-' o parola 'SCONTO'), applicalo al prezzo del prodotto sopra.
        3. MARTINELLI/MOLTIPLICAZIONI: Se vedi 'pz x prezzo' SOPRA un prodotto, usa quel prezzo come unitario.
        4. P_IVA: Estrai la Partita IVA senza spazi.

        NORMALIZZAZIONE (Glossario esistente): [{glossario[:100]}]
        - Proponi un nome standard in 'proposta_normalizzazione' basandoti sul glossario.

        RESTITUISCI SOLO JSON:
        {{
          "testata": {{ "p_iva": "", "indirizzo": "", "data": "" }},
          "prodotti": [
            {{ 
              "nome_letto": "", 
              "prezzo_unitario": 0.0, 
              "quantita": 1, 
              "is_offerta": "SI/NO",
              "proposta_normalizzazione": "",
              "da_normalizzare": "SI"
            }}
          ]
        }}
        """

        print(f"Analisi con {modello_scelto} in corso...")
        response = model.generate_content([prompt, img])
        
        # PULIZIA E PARSING JSON
        raw_text = response.text.strip().replace('```json', '').replace('```', '')
        dati = json.loads(raw_text)
        
        # PAYLOAD (Punto 3)
        print("\n--- JSON PAYLOAD ---")
        print(json.dumps(dati, indent=2))
        
        # ELABORAZIONE TESTATA
        p_iva = dati['testata'].get('p_iva', '').replace(' ', '').replace('.', '')
        insegna = INSEGNE_MAP.get(p_iva, f"SCONOSCIUTO ({p_iva})")
        
        # SCRITTURA SU SHEETS
        nuove_righe = []
        for p in dati.get('prodotti', []):
            riga = [
                dati['testata'].get('data', ''), # A
                insegna,                         # B
                dati['testata'].get('indirizzo', ''), # C
                p.get('nome_letto', '').upper(), # D: NOME LETTO
                p.get('prezzo_unitario', 0) * p.get('quantita', 1), # E
                0,                               # F
                p.get('prezzo_unitario', 0),     # G: PREZZO UNITARIO
                p.get('is_offerta', 'NO'),       # H
                p.get('quantita', 1),            # I
                p.get('da_normalizzare', 'SI'),  # J: DA NORMALIZZARE
                p.get('proposta_normalizzazione', '').upper() # K: PROPOSTA
            ]
            nuove_righe.append(riga)
        
        worksheet.append_rows(nuove_righe)
        print(f"\n✅ Operazione completata. {len(nuove_righe)} righe scritte.")

    except Exception as e:
        print(f"❌ Errore: {e}")

# Esecuzione
analizza_v8()
